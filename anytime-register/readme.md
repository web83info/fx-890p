# Anytime Register

ポケコンの解析をしていて、いつでもレジスタの内容が表示されれば便利だなとおもって、このプログラムを組みました。

## 動作環境

FX-890PとZ-1GRで動きました。Z-1もOKでしょう。

## 入力方法

マシン語で組まれていますので、マシン語エリアを確保する必要があります。 BASICかCALモードで、

```
CLEAR 1024,1611,6144
```

と入力してください。

次に、```anytime-register.bin```をどんな方法でも結構ですから、ポケコンに読み込んでください。バイナリファイルの読み書きのできない方は、```anytime-register.bas```を転送、実行してください。プログラムはリロケータブルなので、マシン語エリアに読み込めば動作します。

| 項目 | 内容 |
| --- |--- |
| 必要メモリー領域 | &H2000〜&H264A, 1611（&H064B）バイト |
| 　プログラム領域 | &H2000〜&H22EA, 747（&H02EB）バイト |
| 　ワークエリア領域 | &H22EB〜&H264A, 864（&H0360）バイト |
| メモリー領域確保コマンド | ```CLEAR 1024,1611,6144``` |
| マシン語保存コマンド | ```BSAVE "FILENAME",&H2000,747,&H2000``` |
| マシン語読込コマンド | ```BLOAD "FILENAME",&H2000``` |
| マシン語実行コマンド | ```DEFSEG=0```<br>```CALL &H2000``` |

## 使い方

プログラムを常駐させるには、先頭番地を```CALL```します。これは電源を切るまで有効です。常駐を解除させるのにも、先頭番地を ```CALL```します。常駐しているときは、プログラム本体を書き換えないでください。暴走するおそれがあります。

常駐した状態で、[SHIFT]+[SPACE] を押すと、レジスタの値が表示されます。これは、ROMのモニターの表示にあわせてありますので、「暴走か？」などと慌てないでください。（暴走したときにたまにこの画面が出るんだよね）。押しているあいだだけ表示していて、キーを放すともとの状態に戻ります。
画面の状態をきちんと保存しているので、VRAMを使っていないようなプログラムでも問題ありません。

## マシン語プログラムについて

マシン語プログラム中でキー割り込みを勝手に乗っ取ったり、割り込みを禁止しているプログラムでは、このソフトは動作しません。

## プログラムについて

アルゴリズムはともかく、このプログラムを作るのは非常に苦労しました。レジスタの値をいかに正確に読み込むかが課題で、様々な試行錯誤をしました。

まず、このルーチンで表示されるのは、キーを押した瞬間におけるレジスタの値であり、レジスタの値を表示するルーチンにおける値ではありません。。
キー割り込みが呼ばれると、```FL```,```CS```,```IP```の順に```PUSH```されます。そういうわけで、ここで表示される```CS:IP```は押された瞬間に実行されていた命令の次の命令の先頭アドレスです。キー割り込みルーチンに入ると、真っ先に```SS```,```ES```,```DS```を```PUSH```します。あとは、```PUSHA```で残りの```AX```,```BX```,```CX```,```DX```,```SI```,```DI```,```SP```,```BP```（この順番ではありませんが）を保存します。```PUSH```命令では、まず```SP```を2減算してからデータをスタックに積みますが、```PUSHA```で積まれる```SP```の値は減算する前のものです。
というわけで、キーを押した瞬間のレジスタの値を取り込むことができます。

他に苦労した点といえば、画面保存ルーチンです。どうしても画面を保存するときに4ドットほど画面がずれてしまいました。なぜそうなるか分からないのですが、読み込むときにはダミーを読み込むことを思い出して何とかなりました。

ところで、LCDCに詳しい人にお伺いしたいのですが、

1. データ書き込み（読み込み）の後のウエイトの計算の仕方

2. 前述（ダミーデータを読み込むこと）の理由

だれかご存じの方がいたらお教えください。

## 参考文献

工学社：Z-1／FX-890P活用研究
