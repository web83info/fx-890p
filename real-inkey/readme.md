# Real INKEY$ Ver.1.0

BASIC しか使えない方は、必ずと言っていいほど同時キー入力判定ができなくて困ったことがおありでしょう。確かに、BASIC で同時キー入力判定をするのは不可能に近いです（不可能、と言い切っていない理由は、後述）。

しかし、そんなあなたでも、簡単に、INKEY$ より速く、しかも正確な、サイズの結構小さい「同時キー入力判定ルーチン」、その名も「Real INKEY$」が華麗に登場です。これで、対戦ゲームもあなたの思いのまま！

## 動作環境

CPUはPentiumで、メモリは16M以上（推奨32M）.... 嘘です。一度書いてみたかっただけです。FX-890P、Z-1で動作します。ただし、実際に動作確認したのは、FX-890Pだけです。Z-1GRは、手元にないので動作保証ができません。

## 入力方法

付録CD-ROMにプログラムが納められております。CD-ROMにアクセスができるWindowsパソコンなどで、ターミナルなどで、ファイルをRS-232Cを経由させて転送するか、またはFDを経由して転送してください。転送するファイルは「REAL.BAS」です。

普通のアスキーファイルとして納められているはずですから、F.COMを使うと便利でしょう。読み込み先は、Pエリアです。
そうしたら、BASICかCALモードで次のように入力してください。

```
CLEAR 1024,&H22F,6144
```

そのようにして、マシン語エリアを確保したら、先程読み込んだファイルを実行してください。実行中にエラーが出るようなら、文字化けなどが発生しているかもしれません。その時は、通信条件などを確認してください。終わったならば、外部記憶装置に、バイナリの形式でセーブしておきましょう。

なお、このプログラムは、リロケータブルなので、モニタで好きな番地に移動することが可能です。RAMを増設していない方は、どの番地でも好きな番地に移動させてください。RAMを増設して、64KB以上ある方でも、ページをまたがなければ問題ありません。
プログラム全体が同一セグメントの中にきちんと収まれば、ページをまたいでいないということです。
プログラムサイズは、230Hバイトです。このプログラムでは、ワークエリアは使っていませんし、また、自己書換もしていません。よって、暴走しない限り、何度実行しても、プログラム自体は書き変わりません。
ソースリストが、「REAL.ASM」の名前で入っているはずなので、それを読み込んでアセンブルしても大丈夫です。

## 使い方

ちょっと癖があるので、しっかり読んでください。

変数領域に、最低188バイト確保してください。ただし、これは最低の値なので、これだけしか確保しないと他の変数が使えません。普通は、変数領域が2KBもあれば十分でしょう。

プログラム中で、次のような命令を実行してください。

```
DIM K$(90)
```

このようにすると、K$が結果格納領域として初期化されます。この文字変数は、K$に固定です。
K$に、ユーザーは一切書き込みしないでください。読み込みだけにしてください。また、添え字の数は90に固定です。それより多くとも少なくともいけません。

その辺りは、実行前にきちんとプログラムがチェックしますので、余り気にしないでください。このようにしないと、BS error が発生します。

キー情報が欲しい際には、プログラムの先頭番地をコールします。配列変数K$の何番目にどのキー情報が格納されているかは、表1を参照してください。できるだけアスキーコードに近づけましたが、一部都合によりそうなっていないところもあります。CHR$(32)が入っていたら押されていた、NULLが入っていたら、押されていなかったということです。

なお、表1にダミーがありますが、これは、キーコードをアスキーコードに近づけたことからくる弊害で、ここは常にNULLが格納されます。

このプログラムではBRKやSTOPのチェックもできます。役に立ったら使ってください。BRKをチェックできても、すぐに実行が中断されてしまうから余り意味がないとは思いますが。さらに、K$の0番目には、何かキーが押されていればCHR$(32)､そうでなければNULLが入ります。

例えば、次のようなサンプルプログラムが考えられます。

```
10 CLS:CLEAR:DIM K$(90)
20 X=0:Y=0
30 LOCATE X,Y:PRINT "A";:Q=X:W=Y
40 CALL &H2000:IF K$(0)="" GOTO 40
50 IF K$(&H36)<>"" AND X<30 THEN X=X+1
60 IF K$(&H34)<>"" AND X>0  THEN X=X-1
70 IF K$(&H38)<>"" AND Y>0  THEN Y=Y-1
80 IF K$(&H32)<>"" AND Y<3  THEN Y=Y+1
90 LOCATE Q,W:PRINT " ";
100 GOTO 30
```

このプログラムを実行してみてください。テンキーで、気持ちいいほどキャラクタがなめらかに動いていくのが分かりますか。同時キー入力ルーチンの力がお分かりいただけたでしょうか。

## 使用上の注意

マシン語ルーチンの中では、BRKキーのチェックをしていません。正確にいうとBRKが押されても、もしそれがマシン語ルーチン中ならば、BASICプログラムは中断しません。ですから、プログラムによっては、BRKが入りにくく感じることがあるかもしれませんが、それは仕様なのでそう思ってください。

## 技術情報

同時キー入力と言っても、厳密には同時ではありません。マシン語ルーチンは非常に高速なので、順番に 90回キー情報を読みにいっても、同時に感じるだけです。しかし、どうしてこんな3時間で組んだルーチンが、INKEY$一回分より速いのでしょうか？ちょっと疑問です。

プログラムは非常に分かりやすい、お手本のようなプログラムです。そのまま、教科書かなんかに掲載してあげたいくらいです。暇な人は解析してみてください。

プログラムの話もしましょう。

まず、エラー処理ですが、BIOSで処理先アドレスが得られないので、バージョンによっては暴走するかもしれません。ジャンプ先アドレスに直接ジャンプしています。

同時キー入力の件ですが、実は、活研のキーマトリックス表はバグっています。PJ'95/2 のほうを参照してください。活研の表は下から3列目と4列目を、右に一つシフトして見てください。

活研の話が出たところで、活研は結構バグがあります。私は既に、数十ヶ所発見しています。Z-1GRの情報とともに、改訂版活研が出ないでしょうかね。＞工学社さん。

次に、リロケータブルなプログラムの作り方ですが、かなり面倒です。注意しなければならないのは、メモリにアクセスするときです。その時だけ、今自分がいるアドレスを計算してやって、そのアドレスより何バイト先に（あるいは手前に）データがあるよ、と計算するわけです。

では、今自分がいるアドレスはどのようにして求められるでしょうか。これには二段階あります。

__CS を求める。__

オペコード表には```MOV AX,CS```などというコードはありません。ではどうすればよいでしょうか。スタックを利用すると簡単に解決します。

```
	PUSH CS
	POP  AX
```

このようにすると、AX に CS が代入されます。

__IP を求める。__

CSはスタックに簡単に積めましたから、何の問題もなかったのですが、IP はちょっと特殊な方法を使います。

```
	CALL IP
IP: POP  AX
```

CALL命令を実行すると、次の命令のアドレスがスタックに積まれて、ジャンプしていきます。ここで、POPを実行すると今自分がいるアドレスが計算できます。この例ではAXにIP:のアドレスが返ってきます。スタックというのはCALLもPUSHも同じところを使うから、変なところにジャンプしてしまうのではないか、という余計な心配はいりませんよ。

ただし、この方法だと、アドレスを求めた番地と、データ領域がセグメントをまたいでしまうときには、うまくいかないとおもいます。オフセットがオーバーフローしてしまっても、セグメントレジスタは（CSは違うとおもいますが）変化しないからです。何かうまい方法はないものでしょうか。

「CALLやJMP命令のときは、アドレスについて考えなくてもいいの？」と思われる方がいらっしゃるかもしれませんが、8086系のCPUでは（PC-E500系と違って）次の命令の先頭番地からの相対アドレスが格納されているので、全く問題ありません。
変数のアクセスの仕方ですが、ここでは、マシン語で固定変数以外の変数をアクセスしています。変数の中身が1文字のときと0文字のときでは使用するメモリは同じ（！）なので、それを利用しています。これは先に、変数エリアを確保してあるからです。

例えば、マニュアルモードで次のように入力してください。

```
CLEAR
DIM K$(90)
SYSTEM（ここで表示される V: の後の数字を覚えておく）
K$(0)="A"
SYSTEM（ここで表示される V: の後の数字を覚えておく）
```

ここで、SYSTEMを実行した後のV:のあとの表示は同じはずです。これを利用すると、記憶させるデータが1文字のときは、データを書き換えるだけで良いことが分かります。2文字以上になると、いちいちデータの移動処理やメモリの容量チェックなどがあり、面倒になります。

まず、BIOSで変数テーブルエリアの先頭アドレスを求めます。そのアドレスから、続く文字変数エリアまでの変数テーブルエリア内で、K$(90)が定義されているか調べます。もし、定義されていなかったらばBS error です。定義されていたら、その配列変数の記憶されているアドレスを調べて、K$()が正常であることを確認して、キーの読み込みに入るのです。

最初は、いきなり文字変数エリアを検索してK$を探していたのですが、CLEAR を実行した後に、実は文字変数データはそのまま残っていて、変数テーブル情報だけ消去されることが判明したので、きちんと変数エリアをチェックするようにしました。

アセンブラのソースリストですが、これは186にしかない命令を使用した箇所があります。探して見てください。これは、386以上でしか動かないという、ふざけたプログラムがあることに対する、私からのささやかな反撃です。ただ単に、プログラムサイズの調整という説も有りますが、お好きな方を選んでください。

## BASIC ONLY のあなたへ

実は、BASICだけでも、同時キー入力判定は可能です。ただ、スピード的にかなりきついとおもいますが。

マニュアルには載っていませんが、BASICには隠し命令として、```OUT```、```INP``` という命令があります。これは、そのままマシン語の```OUT```、```IN``` に対応していて、I/0 ポートにアクセスすることができます。そこで、BASICだけでも同時キー入力ができます。

さらに、番外編として、[SHIFT]を使うという手もあります。一部のキーでは使えませんが、INKEY$だけで処理できるので、お手軽ですよ。

## 著作権のお話

「Real INKEY$」（以下、このプログラム）は Computer fanへの投稿プログラムです。このプログラムは、パブリックドメインではありません。著作権は、作者が保有します｡

このプログラムは、自由にあなたのプログラムに組み込むことができますが、その時は必ず、出典先をドキュメントのどこかに記してください。また、このプログラムを組み込んだプログラムの著作権はあなたにありますが、その時はこのプログラムのソースリストを配布することは認めません。また、そのプログラムに関する責任はすべてあなたにあります。

このプログラムは自由に転載することができるものとします。しかし、転載する際には、ファイル内容は、オリジナルのファイルを改竄しないでください。

作者は、このプログラムを使用した、あるいは使用できなかったことに関する一切の不都合に責任を追わないものとします。また、このプログラムにバグがあっても、バージョンアップは作者の義務ではありません。

このプログラムを改良して、どこかに発表したいと考える方がいるならば、オリジナルのファイルもすべて同時に配布するという条件付きで認めます。

## 参考文献

* こさいん : True INKEY$、PJ'94/11 P44
* 工学社 : Z-1/FX-890P活用研究

## 表1：キーコード対応表

| コード | キー |
| --- | --- |
1 | SHIFT |
| 2 | CAPS |
| 3 | SRCH |
| 4 | IN|
| 5 | OUT |
| 6 | CALC |
| 7 | S（赤い方） |
| 8 | BS |
| 9 | TAB |
| 10 | E（リターンの隣） |
| 11 | MENU |
| 12 | CLS |
| 13 | RET |
| 14 | CAL |
| 15 | SQR |
| 16 | X^2 |
| 17 | DEL |
| 18 | INS |
| 19 | ENG |
| 20 | log |
| 21 | ln |
| 22 | DEGR |
| 23 | sin |
| 24 | cos |
| 25 | tan |
| 26 | MR |
| 27 | M+ |
| 28 | → |
| 29 | ← |
| 30 | ↑ |
| 31 | ↓ |
| 32 | SPC |
| 33 | ^ |
| 34 | STOP |
| 35 | BRK |
| 36 | ダミー |
| 37 | ダミー |
| 38 | ダミー |
| 39 | ダミー |
| 40 | ( |
| 41 | ) |
| 42 | * |
| 43 | + |
| 44 | , |
| 45 | - |
| 46 | . |
| 47 | / |
| 48 | 0 |
| 49 | 1 |
| 50 | 2 |
| 51 | 3 |
| 52 | 4 |
| 53 | 5 |
| 54 | 6 |
| 55 | 7 |
| 56 | 8 |
| 57 | 9 |
| 58 | : |
| 59 | ; |
| 60 | ダミー |
| 61 | = |
| 62 | ダミー |
| 63 | ダミー |
| 64 | ダミー |
| 65 | A |
| 66 | B |
| 67 | C |
| 68 | D |
| 69 | E |
| 70 | F |
| 71 | G |
| 72 | H |
| 73 | I |
| 74 | J |
| 75 | K |
| 76 | L |
| 77 | M |
| 78 | N |
| 79 | O |
| 80 | P |
| 81 | Q |
| 82 | R |
| 83 | S |
| 84 | T |
| 85 | U |
| 86 | V |
| 87 | W |
| 88 | X |
| 89 | Y |
| 90 | Z |
