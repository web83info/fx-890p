# BASIC  Command  Converter  Ver1.01a
 
ポケコンにちょっとした機能を付け加えるプログラムだそうです。
 
## BCCってなあに？

PC-E500系（以下E500）やPC-G800系（以下E200）などのSHARP系のポケコンのBASICは，省略形が使えることにより入力がかなり楽になることで良く知られています。```PRINT```文で3文字，```GOTO```文で2文字，```LOCATE```文で3文字も省略できます。

それに加えて，昨今のプログラムは，サイズが非常に大きくなってきています。最近のPJでもその傾向は見受けられます。

ところで，我らのFX-890P／Z-1（以下Z-1）では残念ながら省略入力機能が使えません。まあ，ないものはないのですから仕方がないのですが。しかし，欲しいものは欲しいので，このわがままは何とかするしかありません。「なければ作る」の大原則に従ってちょっと遊びのつもりで作り始めたはずでした．．．．

なぜか最初に考えたアルゴリズムがある程度うまくいってしまったので，調子にのって作っていくと，このようなものができたので発表したいと思います。

ということで，Z-1でE500／E200のBASICのような，省略入力から普通の命令へのコンバ－タ－が，「BCC」です。E500／E200と同じ，とまでは言いませんが興味のある方は使ってみて下さい。
 
## 対応機種

FX-890Pで動作確認しました。ROMの内容に依存するようなことはしていないはずなので，すべての互換機で動作すると思いますが，確認はしていません。
 
## 入力方法

マシン語で組まれています。まずはマシン語エリアを確保します。

```
CLEAR 1024,2022,6144
``` 
 
次に，```basic-command-converter.bas```を入力します。見かけはBASICプログラムですが，自作のMTOOLを使ってコンバ－トされているので，中身はマシン語プログラムです。

すべて入力し終わったら，必ず外部記憶装置に保存しましょう。そうしたら，
 
```
RUN
```
 
と入力してマシン語を書き込みます。そうしたら2000Hから26DDHまでを保存しましょう。これでこのツ－ルの使用が可能となります。

なお、BASICプログラムのチェックサムは一般的なチェックサムの計算方法と違うので，モニタでは打ち込めません。ご了承ください。
 
| 項目 | 内容 |
| --- |--- |
| 必要メモリー領域 | 2000H〜27E5H, 2022（&H07E6）バイト
| 　プログラム領域 | 2000H〜26DDH, 1758（&H06DE）バイト
| 　ワークエリア領域 | 26DEH〜27E5H, 264（&H0108）バイト
| メモリー領域確保コマンド | ```CLEAR 1024,2022,6144```
| マシン語保存コマンド | ```BSAVE "FILENAME",&H2000,1758,&H2000```
| マシン語読込コマンド | ```BLOAD "FILENAME",&H2000```
| マシン語実行コマンド | ```DEFSEG=0```<br>```CALL &H2000```

 ## 使い方

最初にBASIC命令の省略形を知らなければ話になりません。これを表1にまとめます。それを参考にしてプログラムを打ち込みます（必要なら変更前のプログラムを保存して下さい）。例えば，次のようになります。
 
```
10 F.I=33T.255:P.C.(I);:N.
```

これはキャラクタ－コ－ドを表示するプログラムです。これが[P2]エリアに入っていると仮定しましょう。マシン語プログラムがメモリ上にあることを確認し，

```
DEFSEG=0
CALL&H2000
``` 
 
と入力します。すると，
 
```
Basic Command Converter ver1.00
Which P-Area? [P0]
```

と聞かれますので[2],[RET]と押して下さい。すると，

```
Line=10  Completed!
``` 
 
と表示されプログラムが終了します。
 
```
EDIT
```
 
と入力すると
 
```
10 FORI=33TO255:PRINTCHR$(I);:NEXT
```
 
と変換されているのが確認されます。成功したら，過去のPJから適当なプログラムを選んで入力して正しく動作するかも確認してください。

## 技術情報 必ずお読みください

まず手元に活研を用意して下さい。そうしたら，P90～95を最低10回読んで理解して下さい。

命令は中間コードに変換されていますから，中間コ－ドに変換されない文字はアスキ－コ－ドで格納されています。ですから，文法解析をして省略されている文字列を探しだして，それがどの命令の一部か調べさせます。

1行の先頭から1バイトずつ読んでいって，それが```03H```（行番号を示す）なら続く2バイトを読みとばします。同様に```04H```,```05H```,```06H```,```07H```（命令を表す）なら1バイト，```REM```や```02H```（シングルクオーテーション＝```REM```の省略），または```DATA```の後はその行を読みとばします。さらに”（ダブルクオ－テ－ション）のなかの文字列は変換しないようにプログラムされています。

このようにして，ある特定のワ－クエリアに大文字アルファベットからなる文字列を移動させます（小文字は，大文字に変換されます）。

そうしたらデ－タの変換に入ります。まず，比較されるアルファベットの先頭の文字の先頭アドレスを求めます。そして，変換されるデ－タの中のピリオドか，比較されるデ－タの```00H```かの，どちらかがででくるまで比較を続けます。その中で一つでも異なるデ－タが見つかれば，さらにデ－タの検索を続けます（先頭のアルファベットで始まるデ－タがなくなったらその時点であきらめます）。

もし，比較しても相違がなかったら，その次にある中間コ－ドを読み込んで直接書き換えます。ここで注目して欲しいのは中間コ－ドは2バイト，省略されているものは最低でも2バイトであるということです。さらにアルファベットが増えればさらにメモリを食います（省略入力は省メモリにはならないんですね）。

つまり，ここで空いた分を詰めてやらなければなりません。そこでBIOS(```62H```)を使います。さらに1行の長さを計算して書き換えあげます。

基本的な部分はここまでです。さらに，変換作業が待っています。命令の後に行番号が続くものがあります。その行番号は，```03H + 2Bytes```で表されなければなりません。つまり，16進数で表現するということです。

次です。次の文をみてください。

```
10 IF A THEN 100 ELSE 200
``` 
 
目には見えませんが，内部では次のようになっています。
 
```
10 IF A THEN 100 :ELSE 200
```
 
```ELSE```の前にはコロンに相当するコード(01H)を追加するということです。これが，私を睡眠不足へ追い込んだのです。
 
## 必読！暴走しても知らないよ

内部では，一行に255Bytesまで格納できます。しかし，表示するときに255文字を超えると暴走します。昔あった，1行プログラムなどでなければ特に気にすることはありません。掲載プログラムを打ち込むのであれば，なおさら問題ありません。

それから気になる変換時間ですが，これは[F?]にファイルがあるかないかによって大きく変わります。ちなみに，PJ'96/1の「Overnight Sensation ～時代はあなたに委ねてる～」で約2秒です。結構速いでしょう？

あと```INPUT```についてですが，これは```IN.```としか省略できません。```INP.```とすると，```INP```が別の中間コ－ドに変換されてしまうからです。同様に```MODE```は```MO.```としか省略できません。まあ，実害はないと思いますが。

また```VALF```は```VF.```（某3D格闘ゲ－ムではありません），```DRAWC```は```DRC.```と省略して下さい。他の命令は，例えば```PRINT```なら，
 
```
P.
PR.
PRI.
PRIN.
```

のいずれでもOKです。

さらに一部私独自の判断で，E500／E200の省略方法と異なるものがあります。（```ELSE```と```END```など）

しかしこの順番では嫌な人もいることでしょう。そのような方はソ－スリストを打ち込んで優先順位を変えて下さい。具体的には，次のようにします。

まず，命令の最初のアルファベットのラベルを探します。そして，優先する順に上からならびかえます。なお1単位は，

```
DB '命令'
DB 0
DB XXH,XXH ;中間ｺ-ﾄﾞ
``` 
 
となっています。
  
## 参考分献

* 工学社：Z-1／FX-890P 活用研究
* 「植木屋さん，これでいいですか」さん：「Overnight Sensation ～時代はあなたに委ねてる～」，PJ'96/1 P52
 
 ## 表1：命令表

| 命令 | 省略 |
| --- | --- |
| ABS | AB. |
| ACS | AC. |
| AND | A. |
| ANGLE | ANG. |
| APPEND | AP. |
| ATN | AT. |
| BEEP | B. |
| BLOAD | BL. |
| BSAVE | BS. |
| CALC$ | CALC. |
| CALL | CA. |
| CHAIN | CHA. |
| CHR$ | C. |
| CLEAR | CLE. |
| CLOSE | CLO. |
| CLS | CL. |
| CNT | CN. |
| DATA | D. |
| DIM | DI. |
| DMS | DM. |
| DRAW | DR. |
| DRAWC | DRC. |
| DSKF | DS. |
| ELSE | E. |
| END | EN. |
| EOF | EO. |
| ERASE | ER. |
| EXP | EX. |
| FILES | FIL. |
| FIX | FI. |
| FOR | F. |
| FRAC | FRA. |
| FRE | FR. |
| GOSUB | GOS. |
| GOTO | G. |
| HEX$ | H. |
| HYP | HY. |
| IF | I. |
| INKEY$ | INK. |
| INPUT | IN. |
| KILL | K. |
| LEFT$ | LEF. |
| LEN | LE. |
| LINE | LI. |
| LOCATE | L. |
| LPRINT | LP. |
| MERGE | ME. |
| MID$ | M. |
| MODE | MO. |
| NAME | NA. |
| NCR | NC. |
| NEXT | N. |
| NORM | NOR. |
| NOT | NO. |
| ON | O. |
| OPEN | OP. |
| OUT | OU. |
| PASS | PA. |
| PEEK | PE. |
| POINT | POI. |
| POKE | PO. |
| PRINT | P. |
| RAN# | R. |
| READ | RE. |
| RESTORE | RES. |
| RESUME | RESU. |
| RETURN | RET. |
| RIGHT$ | RI. |
| ROUND | RO. |
| SET | SE. |
| SGN | SG. |
| SIN | SI. |
| SQR | SQ. |
| STAT | STA. |
| STOP | STO. |
| STR$ | S. |
| SYSTEM | SY. |
| TAN | TA. |
| THEN | TH. |
| TIMER | TI. |
| TO | T. |
| USING | U. |
| VAL | V. |
| VALF | VF. |
| WAIT | W. |
| WRITE# | WR. |
| XOR | X. |
